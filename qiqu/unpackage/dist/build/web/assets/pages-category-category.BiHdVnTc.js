import{_ as e,g as t,u as s,b as r,a as o,s as a,n as i,d as l,w as c,i as n,o as d,e as g,f as h,v as u,h as f,j as p,F as y,k as C,l as m,m as _,t as S,p as w}from"./index-DfJFPZaM.js";import{r as T}from"./request.D0Ryayp7.js";import{s as R}from"./user.C6GM3hFr.js";const k=e({data:()=>({categories:[],currentCategory:{},products:[],loading:!1,scrollTop:0,productScrollTop:0,defaultCategoryId:null,isRefreshing:!1}),onShow(){0===this.categories.length&&this.getCategories();const e=t("selectedCategoryId");if(e){const t=this.categories.find((t=>t.id===e));t&&this.switchCategory(t),s("selectedCategoryId")}},onLoad(e){e.id&&(this.defaultCategoryId=Number(e.id)),this.getCategories(e.id)},onTabItemTap(){0===this.categories.length&&this.getCategories()},onHide(){r("categoryData",{categories:this.categories,currentCategory:this.currentCategory,products:this.products})},onShow(){const e=t("categoryData");if(e){if(this.categories=e.categories,this.currentCategory=e.currentCategory,this.products=e.products,this.defaultCategoryId){const e=this.categories.find((e=>e.id===this.defaultCategoryId));e&&this.switchCategory(e),this.defaultCategoryId=null}}else 0===this.categories.length&&this.getCategories()},onPullDownRefresh(){this.refreshData()},methods:{onScroll(e){this.scrollTop=e.detail.scrollTop},onProductScroll(e){this.productScrollTop=e.detail.scrollTop},async getCategories(e){if(!this.loading){this.loading=!0;try{const t=await T({url:"/categories",method:"GET"});if(1===t.code&&t.data&&t.data.length>0){if(this.categories=t.data.filter((e=>e.isActive)),e)this.currentCategory=this.categories.find((t=>t.id===Number(e)))||this.categories[0];else if(this.currentCategory.id){const e=this.categories.find((e=>e.id===this.currentCategory.id));this.currentCategory=e||this.categories[0]}else this.currentCategory=this.categories[0];this.currentCategory&&(this.products=this.currentCategory.products||[])}else this.categories=[],this.products=[],this.currentCategory={},o({title:"暂无分类数据",icon:"none"})}catch(t){console.error("获取分类失败:",t),o({title:"获取分类失败",icon:"none"})}finally{this.loading=!1,this.isRefreshing&&(this.isRefreshing=!1,a())}}},switchCategory(e){e&&e.id&&this.currentCategory.id!==e.id&&(this.currentCategory=e,this.products=e.products||[],this.productScrollTop=0)},async onRefresh(){await this.refreshData()},async refreshData(){this.isRefreshing=!0,this.categories=[],this.products=[],this.currentCategory={},await this.getCategories(),s("categoryData"),a(),this.isRefreshing=!1,o({title:"刷新成功",icon:"success",duration:1500})},goDetail(e){i({url:`/pages/product/detail?id=${e}`,fail:e=>{console.error("跳转失败:",e),o({title:"页面跳转失败",icon:"none"})}})},async handleSendEmailCode(e,t){try{const s=await R({username:e,email:t});1===s.code?o({title:s.message||"验证码已发送",icon:"success"}):o({title:s.message||"发送失败",icon:"none"})}catch(s){console.error("发送验证码失败:",s),o({title:"发送失败，请重试",icon:"none"})}}}},[["render",function(e,t,s,r,o,a){const i=C,T=n,R=m,k=w;return d(),l(T,{class:"container"},{default:c((()=>[g(T,{class:"nav-bar"},{default:c((()=>[g(i,null,{default:c((()=>[h("商品分类")])),_:1})])),_:1}),o.loading?(d(),l(T,{key:0,class:"loading"},{default:c((()=>[g(i,null,{default:c((()=>[h("加载中...")])),_:1})])),_:1})):u("",!0),g(T,{class:"content"},{default:c((()=>[g(R,{class:"category-list","scroll-y":"","scroll-top":o.scrollTop,onScroll:a.onScroll},{default:c((()=>[(d(!0),f(y,null,p(o.categories,(e=>(d(),l(T,{class:_(["category-item",{active:o.currentCategory.id===e.id}]),key:e.id,onClick:t=>a.switchCategory(e)},{default:c((()=>[g(i,null,{default:c((()=>[h(S(e.name),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1},8,["scroll-top","onScroll"]),g(R,{class:"product-list","scroll-y":"","scroll-top":o.productScrollTop,onScroll:a.onProductScroll,onScrolltolower:e.loadMore,"refresher-enabled":"","refresher-triggered":o.isRefreshing,onRefresherrefresh:a.onRefresh},{default:c((()=>[(d(!0),f(y,null,p(o.products,(e=>(d(),l(T,{class:"product-item",key:e.id,onClick:t=>a.goDetail(e.id)},{default:c((()=>[g(k,{src:e.image||"/static/images/default.png",mode:"aspectFill"},null,8,["src"]),g(T,{class:"info"},{default:c((()=>[g(i,{class:"name"},{default:c((()=>[h(S(e.name),1)])),_:2},1024),g(i,{class:"price"},{default:c((()=>[h("¥"+S(e.price),1)])),_:2},1024),g(i,{class:"desc"},{default:c((()=>[h(S(e.description),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128)),0===o.products.length?(d(),l(T,{key:0,class:"empty"},{default:c((()=>[g(i,null,{default:c((()=>[h("暂无商品")])),_:1})])),_:1})):u("",!0)])),_:1},8,["scroll-top","onScroll","onScrolltolower","refresher-triggered","onRefresherrefresh"])])),_:1})])),_:1})}],["__scopeId","data-v-ce1ad508"]]);export{k as default};
