import{_ as e,a as s,D as t,$ as a,G as d,n as l,x as r,r as o,y as i,d as n,w as c,i as u,o as f,e as m,f as p,m as y,t as h,h as _,j as g,F as v,k as A,A as I,p as b}from"./index-DfJFPZaM.js";import{c as T}from"./order.CGxIaE0u.js";import{g as w}from"./user.C6GM3hFr.js";import{g as k}from"./address.C_JEwSJw.js";import{r as x}from"./request.D0Ryayp7.js";const S=e({data:()=>({orderInfo:{products:[],totalAmount:0},paymentOptions:[{label:"支付宝",value:"alipay",icon:"icon-alipay"},{label:"微信支付",value:"wechat",icon:"icon-wechat"}],selectedPayment:"alipay",userInfo:null,deliveryType:"express",selectedAddress:null}),computed:{totalAmount(){return Number(this.orderInfo.totalAmount).toFixed(2)}},onLoad(e){if(e.orderInfo)try{this.orderInfo=JSON.parse(decodeURIComponent(e.orderInfo)),console.log("接收到的订单信息:",this.orderInfo)}catch(d){console.error("解析订单信息失败:",d),s({title:"订单信息错误",icon:"none"}),setTimeout((()=>{t()}),1500)}this.initData(),a("addressSelected",this.handleAddressSelected)},onUnload(){d("addressSelected",this.handleAddressSelected)},methods:{generateOrderId:()=>`${(new Date).getTime()}${Math.floor(1e3*Math.random()).toString().padStart(3,"0")}`,async initData(){try{const e=await w();1===e.code&&e.data?(this.userInfo=e.data,"express"===this.deliveryType&&await this.loadAddressList()):l({url:"/pages/login/login"})}catch(e){console.error("初始化数据失败:",e)}},async loadAddressList(){var e;try{const s=await k(this.userInfo.id);1===s.code&&(null==(e=s.data)?void 0:e.length)>0&&(this.selectedAddress=s.data[0])}catch(s){console.error("加载地址列表失败:",s)}},handleAddressClick(){"express"===this.deliveryType&&l({url:"/pages/address/list?select=true"})},handleAddressSelected(e){if(e){this.selectedAddress=e;const s=document.querySelector(".address-card");s&&(s.classList.add("address-selected"),setTimeout((()=>{s.classList.remove("address-selected")}),500))}},async changeDeliveryType(e){this.deliveryType=e,"express"!==e||this.selectedAddress||await this.loadAddressList()},handleImageError(e){const s=e.target;s&&(s.src="/static/images/default-product.png")},selectPayment(e){this.selectedPayment=e},async beforeSubmitOrder(){return"self"===this.deliveryType||(!("express"===this.deliveryType&&!this.selectedAddress)||(s({title:"请选择收货地址",icon:"none"}),!1))},async submitOrder(){if(!(await this.beforeSubmitOrder()))return;const e=document.querySelector(".submit-btn");e&&(e.classList.add("submit-btn-active"),setTimeout((()=>{e.classList.remove("submit-btn-active")}),200));try{r({title:"提交中"});const e=this.generateOrderId(),s=new Date,a={id:e,userId:this.userInfo.id,totalAmount:Number(this.totalAmount),status:"待付款",deliveryType:this.deliveryType,paymentMethod:this.selectedPayment,createdAt:s,updatedAt:s,addressId:"self"===this.deliveryType?0:this.selectedAddress.id},d=await T(a);if(1!==d.code){if(d.message&&d.message.includes("重复"))return console.log("订单号重复，重新尝试"),void(await this.submitOrder());throw new Error(d.message||"创建订单失败")}for(const l of this.orderInfo.products){const s={orderId:e,productId:l.id,quantity:l.quantity,price:l.price,userAddressId:"self"===this.deliveryType?0:this.selectedAddress.id};if(1!==(await(t=s,x({url:"/orderDetails",method:"POST",data:t}))).code)throw new Error("创建订单详情失败")}o({url:`/pages/payment/index?orderNo=${e}&amount=${this.totalAmount}&name=${encodeURIComponent(this.orderInfo.products[0].name)}&payType=${"wechat"===this.selectedPayment?"wxpay":"alipay"}`})}catch(a){console.error("提交订单失败:",a),s({title:a.message||"提交订单失败",icon:"none"})}finally{i()}var t}}},[["render",function(e,s,t,a,d,l){const r=A,o=u,i=b,T=I;return f(),n(o,{class:"container"},{default:c((()=>[m(o,{class:"delivery-section"},{default:c((()=>[m(r,{class:"section-title"},{default:c((()=>[p("配送方式")])),_:1}),m(o,{class:"delivery-options"},{default:c((()=>[m(o,{class:y(["delivery-item",{active:"express"===d.deliveryType}]),onClick:s[0]||(s[0]=e=>l.changeDeliveryType("express"))},{default:c((()=>[m(r,{class:"iconfont icon-express"}),m(r,null,{default:c((()=>[p("快递配送")])),_:1})])),_:1},8,["class"]),m(o,{class:y(["delivery-item",{active:"self"===d.deliveryType}]),onClick:s[1]||(s[1]=e=>l.changeDeliveryType("self"))},{default:c((()=>[m(r,{class:"iconfont icon-pickup"}),m(r,null,{default:c((()=>[p("自提柜自提")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1}),"express"===d.deliveryType?(f(),n(o,{key:0,class:"address-card",onClick:l.handleAddressClick},{default:c((()=>[d.selectedAddress?(f(),n(o,{key:0,class:"address-info"},{default:c((()=>[m(o,{class:"user-info"},{default:c((()=>[m(r,{class:"name"},{default:c((()=>[p(h(d.selectedAddress.recipientName),1)])),_:1}),m(r,{class:"phone"},{default:c((()=>[p(h(d.selectedAddress.phone),1)])),_:1})])),_:1}),m(o,{class:"address"},{default:c((()=>[p(h(d.selectedAddress.address),1)])),_:1})])),_:1})):(f(),n(o,{key:1,class:"no-address"},{default:c((()=>[m(r,null,{default:c((()=>[p("请选择收货地址")])),_:1})])),_:1})),m(r,{class:"iconfont icon-right"})])),_:1},8,["onClick"])):(f(),n(o,{key:1,class:"address-card"},{default:c((()=>[m(o,{class:"address-info"},{default:c((()=>[m(o,{class:"user-info"},{default:c((()=>[m(r,{class:"name"},{default:c((()=>[p("自提柜自提")])),_:1})])),_:1}),m(o,{class:"address"},{default:c((()=>[p("商品将配送至就近的自提柜，请注意查收提货码")])),_:1})])),_:1})])),_:1})),m(o,{class:"goods-card"},{default:c((()=>[(f(!0),_(v,null,g(d.orderInfo.products,(e=>(f(),n(o,{class:"goods-item",key:e.id},{default:c((()=>[m(i,{src:e.image,mode:"aspectFill",class:"goods-image",onError:l.handleImageError},null,8,["src","onError"]),m(o,{class:"goods-info"},{default:c((()=>[m(r,{class:"goods-name"},{default:c((()=>[p(h(e.name),1)])),_:2},1024),m(o,{class:"goods-price-wrap"},{default:c((()=>[m(r,{class:"goods-price"},{default:c((()=>[p("¥"+h(e.price),1)])),_:2},1024),m(r,{class:"goods-count"},{default:c((()=>[p("x"+h(e.quantity),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),m(o,{class:"payment-card"},{default:c((()=>[m(o,{class:"card-title"},{default:c((()=>[p("支付方式")])),_:1}),m(o,{class:"payment-options"},{default:c((()=>[(f(!0),_(v,null,g(d.paymentOptions,((e,s)=>(f(),n(o,{class:y(["payment-item",{active:d.selectedPayment===e.value}]),key:s,onClick:s=>l.selectPayment(e.value)},{default:c((()=>[m(r,{class:y(["iconfont",e.icon])},null,8,["class"]),m(r,null,{default:c((()=>[p(h(e.label),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),m(o,{class:"amount-card"},{default:c((()=>[m(o,{class:"amount-item"},{default:c((()=>[m(r,null,{default:c((()=>[p("商品金额")])),_:1}),m(r,null,{default:c((()=>[p("¥"+h(d.orderInfo.totalAmount),1)])),_:1})])),_:1}),m(o,{class:"amount-item total"},{default:c((()=>[m(r,null,{default:c((()=>[p("实付款")])),_:1}),m(r,{class:"price"},{default:c((()=>[p("¥"+h(l.totalAmount),1)])),_:1})])),_:1})])),_:1}),m(o,{class:"bottom-bar"},{default:c((()=>[m(o,{class:"total-wrap"},{default:c((()=>[m(r,null,{default:c((()=>[p("合计：")])),_:1}),m(r,{class:"price"},{default:c((()=>[p("¥"+h(l.totalAmount),1)])),_:1})])),_:1}),m(T,{class:"submit-btn",onClick:l.submitOrder},{default:c((()=>[p("提交订单")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-b621f4cb"]]);export{S as default};
