import{_ as t,b as e,n as s,a,x as l,y as c,z as o,c as i,d as n,w as r,i as d,o as u,h as f,j as p,F as h,e as g,f as m,m as y,v as k,t as I,k as _,p as C,l as w,A as L,I as v}from"./index-DfJFPZaM.js";import{g as q,u as S,d as b}from"./cart.BQjnrQyK.js";import{b as A}from"./product.Dc_v3CX8.js";import{g as x}from"./user.C6GM3hFr.js";import"./request.D0Ryayp7.js";const j=t({data:()=>({cartList:[],loading:!1,userInfo:null}),computed:{isAllSelected(){return this.cartList.length>0&&this.cartList.every((t=>t.selected))},selectedCount(){return this.cartList.filter((t=>t.selected)).length},totalPrice(){return this.cartList.filter((t=>t.selected)).reduce(((t,e)=>{var s;return t+((null==(s=e.productInfo)?void 0:s.price)||0)*e.quantity}),0).toFixed(2)}},onShow(){this.checkUserAndLoadCart()},methods:{async checkUserAndLoadCart(){try{const t=await x();1===t.code&&t.data?(this.userInfo=t.data,e("userInfo",t.data),await this.loadCartList()):s({url:"/pages/login/login"})}catch(t){console.error("获取用户信息失败:",t),a({title:"请先登录",icon:"none"}),s({url:"/pages/login/login"})}},async loadCartList(){if(this.userInfo&&this.userInfo.id)try{l({title:"加载中"});const t=await q(this.userInfo.id);if(1!==t.code)throw new Error(t.message||"获取购物车失败");this.cartList=t.data||[],await this.loadProductDetails()}catch(t){console.error("获取购物车失败:",t),a({title:t.message||"获取购物车失败",icon:"none"})}finally{c()}else console.error("用户未登录")},async loadProductDetails(){const t=this.cartList.map((async t=>{try{const e=await A(t.productId);1===e.code&&(t.productInfo=e.data)}catch(e){console.error(`获取商品${t.productId}详情失败:`,e),t.productInfo=null}}));await Promise.all(t)},async toggleSelect(t){try{const e={...t,selected:!t.selected},s=await S(t.id,e);if(1!==s.code)throw new Error(s.message||"更新失败");{const e=this.cartList.findIndex((e=>e.id===t.id));-1!==e&&(this.cartList[e].selected=!t.selected)}}catch(e){console.error("更新购物车失败:",e),a({title:e.message||"更新失败",icon:"none"})}},async toggleSelectAll(){const t=!this.isAllSelected;try{for(const e of this.cartList)e.selected!==t&&(await S(e.id,{...e,selected:t}),e.selected=t)}catch(e){console.error("更新购物车失败:",e),a({title:"更新失败",icon:"none"})}},async updateQuantity(t,e){if(!this.userInfo)return;const s=t.quantity+e;if(!(s<1))try{const e={...t,quantity:s,userId:this.userInfo.id},a=await S(t.id,e);if(1!==a.code)throw new Error(a.message||"更新失败");{const e=this.cartList.findIndex((e=>e.id===t.id));-1!==e&&(this.cartList[e].quantity=s)}}catch(l){console.error("更新购物车失败:",l),a({title:l.message||"更新失败",icon:"none"})}},async handleQuantityInput(t){const e=parseInt(t.quantity);(isNaN(e)||e<1)&&(t.quantity=1),await this.updateQuantity(t,0)},async deleteItem(t){this.userInfo&&o({title:"提示",content:"确定要删除该商品吗？",success:async e=>{if(e.confirm)try{const e=await b(t.id);if(1!==e.code)throw new Error(e.message||"删除失败");{const e=this.cartList.findIndex((e=>e.id===t.id));-1!==e&&this.cartList.splice(e,1),a({title:"删除成功",icon:"success"})}}catch(s){console.error("删除购物车商品失败:",s),a({title:s.message||"删除失败",icon:"none"})}}})},checkout(){if(0===this.cartList.filter((t=>t.selected)).length)return a({title:"请选择商品",icon:"none"});s({url:"/pages/order/create?from=cart"})},goShopping(){i({url:"/pages/mall/mall"})},goToDetail(t){s({url:`/pages/product/detail?id=${t}`})}}},[["render",function(t,e,s,a,l,c){const o=_,i=d,q=C,S=v,b=w,A=L;return u(),n(i,{class:"container"},{default:r((()=>[l.cartList.length>0?(u(),n(b,{key:0,"scroll-y":"",class:"cart-list"},{default:r((()=>[(u(!0),f(h,null,p(l.cartList,((t,e)=>(u(),n(i,{class:"cart-item",key:t.id},{default:r((()=>{var e;return[g(i,{class:"select-wrap",onClick:e=>c.toggleSelect(t)},{default:r((()=>[g(i,{class:y(["select-icon",{active:t.selected}])},{default:r((()=>[t.selected?(u(),n(o,{key:0,class:"iconfont icon-check"})):k("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"]),g(q,{src:(null==(e=t.productInfo)?void 0:e.image)||"/static/images/default.png",mode:"aspectFill",class:"product-image",onClick:e=>c.goToDetail(t.productId)},null,8,["src","onClick"]),g(i,{class:"product-info"},{default:r((()=>[g(o,{class:"name",onClick:e=>c.goToDetail(t.productId)},{default:r((()=>{var e;return[m(I((null==(e=t.productInfo)?void 0:e.name)||"商品已下架"),1)]})),_:2},1032,["onClick"]),g(i,{class:"price-wrap"},{default:r((()=>[g(o,{class:"price"},{default:r((()=>{var e;return[m("¥"+I((null==(e=t.productInfo)?void 0:e.price)||"0.00"),1)]})),_:2},1024),g(i,{class:"quantity-control"},{default:r((()=>[g(o,{class:y(["minus",{disabled:t.quantity<=1}]),onClick:e=>c.updateQuantity(t,-1)},{default:r((()=>[m("-")])),_:2},1032,["class","onClick"]),g(S,{type:"number",modelValue:t.quantity,"onUpdate:modelValue":e=>t.quantity=e,onBlur:e=>c.handleQuantityInput(t)},null,8,["modelValue","onUpdate:modelValue","onBlur"]),g(o,{class:"plus",onClick:e=>c.updateQuantity(t,1)},{default:r((()=>[m("+")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024),g(o,{class:"delete-btn",onClick:e=>c.deleteItem(t)},{default:r((()=>[m("×")])),_:2},1032,["onClick"])]})),_:2},1024)))),128))])),_:1})):(u(),n(i,{key:1,class:"empty"},{default:r((()=>[g(q,{src:"/static/images/empty-cart.png",mode:"aspectFit",class:"empty-image"}),g(o,null,{default:r((()=>[m("购物车还是空的")])),_:1}),g(A,{class:"go-shopping",onClick:c.goShopping},{default:r((()=>[m("去逛逛")])),_:1},8,["onClick"])])),_:1})),l.cartList.length>0?(u(),n(i,{key:2,class:"footer"},{default:r((()=>[g(i,{class:"select-all",onClick:c.toggleSelectAll},{default:r((()=>[g(i,{class:y(["select-icon",{active:c.isAllSelected}])},{default:r((()=>[c.isAllSelected?(u(),n(o,{key:0,class:"iconfont icon-check"})):k("",!0)])),_:1},8,["class"]),g(o,null,{default:r((()=>[m("全选")])),_:1})])),_:1},8,["onClick"]),g(i,{class:"total"},{default:r((()=>[g(o,null,{default:r((()=>[m("合计：")])),_:1}),g(o,{class:"price"},{default:r((()=>[m("¥"+I(c.totalPrice),1)])),_:1})])),_:1}),g(A,{class:"checkout-btn",disabled:0===c.selectedCount,onClick:c.checkout},{default:r((()=>[m(" 结算("+I(c.selectedCount)+") ",1)])),_:1},8,["disabled","onClick"])])),_:1})):k("",!0)])),_:1})}],["__scopeId","data-v-b5ad685e"]]);export{j as default};
