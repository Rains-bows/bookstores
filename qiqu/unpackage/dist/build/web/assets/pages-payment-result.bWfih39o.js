import{_ as t,z as a,a as s,C as e,d as o,w as l,i,o as n,e as c,m as r,f as d,t as u,v as p,p as y,k as _,A as S}from"./index-DfJFPZaM.js";import{q as g,u as f}from"./order.CGxIaE0u.js";import{n as m,r as h}from"./payment.D35KjZXE.js";import"./request.D0Ryayp7.js";const C=t({data:()=>({orderNo:"",orderAmount:"",payType:"",payStatus:"",tradeNo:"",sign:"",loading:!1,isPickupDelivery:!1,pickupCode:""}),onLoad(){const t=window.location.hash.split("?")[1];if(t){const s=new URLSearchParams(t);this.orderNo=s.get("out_trade_no")||"",this.orderAmount=s.get("money")||"",this.payType=s.get("type")||"",this.tradeNo=s.get("trade_no")||"",this.payStatus="TRADE_SUCCESS"===s.get("trade_status")?"SUCCESS":"FAIL",this.sign=s.get("sign")||"";const e=s.get("address")||"";e.includes("自提柜取件码：")&&(this.isPickupDelivery=!0,this.pickupCode=e.split("自提柜取件码：")[1]),"SUCCESS"===this.payStatus&&this.isPickupDelivery&&a({title:"请保存取件码",content:"请截图保存取件码，凭码到自提柜取件",showCancel:!1,confirmText:"我知道了"}),"SUCCESS"===this.payStatus&&this.handlePaymentNotify()}},methods:{async handlePaymentNotify(){if(!this.loading){this.loading=!0;try{const t=window.location.hash.split("?")[1];if(!t)throw new Error("未获取到支付参数");const a=new URLSearchParams(t),e={pid:a.get("pid"),trade_no:a.get("trade_no"),out_trade_no:a.get("out_trade_no"),type:a.get("type"),name:a.get("name"),money:a.get("money"),trade_status:a.get("trade_status"),sign:a.get("sign"),sign_type:a.get("sign_type"),timestamp:a.get("timestamp"),charset:a.get("charset"),version:a.get("version")};if(Object.keys(e).forEach((t=>{e[t]||delete e[t]})),console.log("通知参数:",e),!e.out_trade_no||!e.trade_no||!e.sign)throw new Error("缺少必要的支付参数");const o=await m(e);console.log("支付异步通知结果:",o);const l=await h(e);console.log("支付同步通知结果:",l);const i=await g(e.out_trade_no);if(console.log("查询订单状态结果:",i),1!==i.code||!i.data)throw new Error(i.message||"查询订单状态失败");{const t="TRADE_SUCCESS"===i.data.trade_status||"1"===i.data.status||1===i.data.status;if(this.payStatus=t?"SUCCESS":"FAIL",t){const t={status:"已付款",payTime:(new Date).toISOString(),payType:e.type,tradeNo:e.trade_no,payAmount:e.money,payStatus:"SUCCESS"},a=await f(e.out_trade_no,t);1!==a.code?(console.error("更新订单状态失败:",a.message),s({title:"更新订单状态失败",icon:"none"})):s({title:"支付成功",icon:"success"})}else s({title:"支付失败",icon:"none"})}}catch(t){console.error("处理支付通知失败:",t),s({title:t.message||"处理支付通知失败",icon:"none"}),this.payStatus="FAIL"}finally{this.loading=!1}}},goToOrderDetail(){e({url:"/pages/order/list"})},goToHome(){e({url:"/pages/mall/mall"})}}},[["render",function(t,a,s,e,g,f){const m=y,h=i,C=_,w=S;return n(),o(h,{class:"container"},{default:l((()=>[c(h,{class:"result-card"},{default:l((()=>[c(h,{class:"status-section"},{default:l((()=>[c(h,{class:r(["status-icon",{success:"SUCCESS"===g.payStatus}])},{default:l((()=>[c(m,{src:"/static/images/"+("SUCCESS"===g.payStatus?"success.png":"fail.png"),mode:"aspectFit"},null,8,["src"])])),_:1},8,["class"]),c(h,{class:r(["status-text",{success:"SUCCESS"===g.payStatus}])},{default:l((()=>[d(u("SUCCESS"===g.payStatus?"支付成功":"支付失败"),1)])),_:1},8,["class"]),c(h,{class:"status-amount"},{default:l((()=>[c(C,{class:"currency"},{default:l((()=>[d("¥")])),_:1}),c(C,{class:"amount"},{default:l((()=>[d(u(g.orderAmount),1)])),_:1})])),_:1})])),_:1}),"SUCCESS"===g.payStatus&&g.isPickupDelivery?(n(),o(h,{key:0,class:"pickup-code-section"},{default:l((()=>[c(h,{class:"pickup-code-title"},{default:l((()=>[d("取件码")])),_:1}),c(h,{class:"pickup-code"},{default:l((()=>[d(u(g.pickupCode),1)])),_:1}),c(h,{class:"pickup-tips"},{default:l((()=>[c(C,null,{default:l((()=>[d("请截图保存取件码")])),_:1}),c(C,null,{default:l((()=>[d("凭此取件码到自提柜取件")])),_:1})])),_:1})])),_:1})):p("",!0),c(h,{class:"order-info"},{default:l((()=>[c(h,{class:"info-item"},{default:l((()=>[c(C,{class:"label"},{default:l((()=>[d("订单编号")])),_:1}),c(C,{class:"value"},{default:l((()=>[d(u(g.orderNo),1)])),_:1})])),_:1}),c(h,{class:"info-item"},{default:l((()=>[c(C,{class:"label"},{default:l((()=>[d("支付方式")])),_:1}),c(C,{class:"value"},{default:l((()=>[c(m,{src:"/static/images/"+("alipay"===g.payType?"alipay-small.png":"wxpay-small.png"),mode:"aspectFit",class:"pay-icon"},null,8,["src"]),d(" "+u("alipay"===g.payType?"支付宝":"微信支付"),1)])),_:1})])),_:1}),c(h,{class:"info-item"},{default:l((()=>[c(C,{class:"label"},{default:l((()=>[d("支付时间")])),_:1}),c(C,{class:"value"},{default:l((()=>[d(u((new Date).toLocaleString()),1)])),_:1})])),_:1})])),_:1}),c(h,{class:"actions"},{default:l((()=>[c(w,{class:"btn primary",onClick:f.goToOrderDetail},{default:l((()=>[d("查看订单")])),_:1},8,["onClick"]),c(w,{class:"btn secondary",onClick:f.goToHome},{default:l((()=>[d("返回首页")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-fcebadc1"]]);export{C as default};
